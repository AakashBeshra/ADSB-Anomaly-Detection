<!DOCTYPE html>
<html>
<head>
    <title>ADS-B Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0a0f1e;
            color: white;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            color: #00b4d8;
            border-bottom: 2px solid #1d4ed8;
            padding-bottom: 10px;
        }
        
        .test {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
            background: rgba(26, 31, 46, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .success { 
            background: rgba(25, 135, 84, 0.2); 
            border-color: #198754; 
        }
        
        .error { 
            background: rgba(220, 53, 69, 0.2); 
            border-color: #dc3545; 
        }
        
        .warning { 
            background: rgba(255, 193, 7, 0.2); 
            border-color: #ffc107; 
        }
        
        .info { 
            background: rgba(13, 110, 253, 0.2); 
            border-color: #0d6efd; 
        }
        
        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .logs {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-time {
            color: #6c757d;
            margin-right: 10px;
        }
        
        .log-success { color: #00ff88; }
        .log-error { color: #ff4444; }
        .log-warning { color: #ffc107; }
        .log-info { color: #60a5fa; }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .result-card {
            background: rgba(26, 31, 46, 0.8);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .result-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .result-label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online { background: #00ff88; box-shadow: 0 0 8px #00ff88; }
        .status-offline { background: #ff4444; box-shadow: 0 0 8px #ff4444; }
        .status-connecting { background: #ffc107; box-shadow: 0 0 8px #ffc107; }
        
        pre {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .copy-btn {
            padding: 5px 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-top: 10px;
        }
        
        .copy-btn:hover {
            background: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <h1>üîß ADS-B Connection Diagnostics</h1>
    
    <div class="test warning" id="status">
        <div style="display: flex; align-items: center;">
            <span class="status-indicator status-connecting"></span>
            <span>Click "Run All Tests" to begin</span>
        </div>
    </div>
    
    <div class="controls">
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="testBackend()">Test Backend API</button>
        <button onclick="testWebSocket()">Test WebSocket</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div class="result-grid" id="results">
        <!-- Results will be added here -->
    </div>
    
    <div class="test info">
        <h3>üìã Test Checklist</h3>
        <div style="font-size: 14px; line-height: 1.6;">
            <div><input type="checkbox" id="check1"> Backend running on port 8000</div>
            <div><input type="checkbox" id="check2"> WebSocket connection established</div>
            <div><input type="checkbox" id="check3"> Frontend running on port 3000</div>
            <div><input type="checkbox" id="check4"> No CORS errors in console</div>
            <div><input type="checkbox" id="check5"> Real-time data flowing</div>
        </div>
    </div>
    
    <div class="test info">
        <h3>üîß Quick Fixes</h3>
        <div style="font-size: 14px; line-height: 1.6;">
            <p><strong>If backend isn't running:</strong></p>
            <pre id="backendCommand">cd backend
python -m venv venv
venv\Scripts\activate  # Windows
# OR
source venv/bin/activate  # Mac/Linux
pip install -r requirements.txt
uvicorn src.main:app --reload --host 0.0.0.0 --port 8000</pre>
            <button class="copy-btn" onclick="copyToClipboard('backendCommand')">Copy Commands</button>
            
            <p style="margin-top: 15px;"><strong>If frontend isn't running:</strong></p>
            <pre id="frontendCommand">cd frontend
python -m http.server 3000</pre>
            <button class="copy-btn" onclick="copyToClipboard('frontendCommand')">Copy Commands</button>
        </div>
    </div>
    
    <div class="logs" id="logs">
        <div class="log-entry">
            <span class="log-time">[--:--:--]</span>
            <span>Ready to run tests...</span>
        </div>
    </div>
    
    <script>
        const logs = document.getElementById('logs');
        const results = document.getElementById('results');
        const status = document.getElementById('status');
        let testResults = {};
        
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${time}] ${message}`);
        }
        
        function updateStatus(message, type = 'warning') {
            const indicator = status.querySelector('.status-indicator');
            const text = status.querySelector('span:last-child');
            
            status.className = `test ${type}`;
            indicator.className = `status-indicator status-${type}`;
            text.textContent = message;
        }
        
        function updateChecklist(id, checked) {
            const checkbox = document.getElementById(`check${id}`);
            if (checkbox) {
                checkbox.checked = checked;
            }
        }
        
        function addResult(name, value, label, type = 'info') {
            // Remove existing result if present
            const existing = document.querySelector(`[data-result="${name}"]`);
            if (existing) {
                existing.remove();
            }
            
            const div = document.createElement('div');
            div.className = 'result-card';
            div.setAttribute('data-result', name);
            
            let displayValue = value;
            let valueClass = '';
            
            if (typeof value === 'boolean') {
                displayValue = value ? '‚úÖ PASS' : '‚ùå FAIL';
                valueClass = value ? 'log-success' : 'log-error';
            } else if (typeof value === 'number') {
                displayValue = value.toLocaleString();
            }
            
            div.innerHTML = `
                <div class="result-label">${label}</div>
                <div class="result-value ${valueClass}">${displayValue}</div>
            `;
            
            results.appendChild(div);
            testResults[name] = {value, label, type};
        }
        
        function clearLogs() {
            logs.innerHTML = '';
            log('Logs cleared', 'info');
        }
        
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                log('Commands copied to clipboard', 'success');
            }).catch(err => {
                log('Failed to copy: ' + err, 'error');
            });
        }
        
        async function testBackend() {
            updateStatus('Testing backend connection...', 'warning');
            log('Testing backend API...', 'info');
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/health', {
                    signal: AbortSignal.timeout(5000)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addResult('backend', true, 'Backend API', 'success');
                    updateChecklist(1, true);
                    
                    // Test additional endpoints
                    log('Testing additional endpoints...', 'info');
                    
                    const endpoints = [
                        ['/api/v1/flights?limit=5', 'Flights API'],
                        ['/api/v1/anomalies?limit=5', 'Anomalies API'],
                        ['/api/v1/stats', 'Stats API']
                    ];
                    
                    for (const [endpoint, name] of endpoints) {
                        try {
                            const endpointResponse = await fetch(`http://localhost:8000${endpoint}`, {
                                signal: AbortSignal.timeout(3000)
                            });
                            log(`${name}: ${endpointResponse.ok ? '‚úÖ OK' : '‚ùå Failed'}`, 
                                endpointResponse.ok ? 'success' : 'error');
                        } catch (e) {
                            log(`${name}: ‚ùå Error - ${e.message}`, 'error');
                        }
                    }
                    
                    log('‚úÖ Backend is running and responding', 'success');
                    updateStatus('Backend connection successful!', 'success');
                    return data;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addResult('backend', false, 'Backend API', 'error');
                updateChecklist(1, false);
                log(`‚ùå Backend connection failed: ${error.message}`, 'error');
                updateStatus('Backend connection failed', 'error');
                return null;
            }
        }
        
        async function testWebSocket() {
            updateStatus('Testing WebSocket connection...', 'warning');
            log('Testing WebSocket...', 'info');
            
            return new Promise((resolve) => {
                const ws = new WebSocket('ws://localhost:8000/ws');
                let timeout;
                let connected = false;
                
                ws.onopen = function() {
                    clearTimeout(timeout);
                    connected = true;
                    addResult('websocket', true, 'WebSocket', 'success');
                    updateChecklist(2, true);
                    log('‚úÖ WebSocket connection established', 'success');
                    
                    // Test ping-pong
                    ws.send(JSON.stringify({ type: 'ping' }));
                    
                    setTimeout(() => {
                        ws.close();
                        updateStatus('WebSocket connection successful!', 'success');
                        resolve(true);
                    }, 1000);
                };
                
                ws.onerror = function(error) {
                    clearTimeout(timeout);
                    addResult('websocket', false, 'WebSocket', 'error');
                    updateChecklist(2, false);
                    log(`‚ùå WebSocket connection failed`, 'error');
                    
                    let message = 'Connection failed';
                    if (error && error.message) {
                        message = error.message;
                    }
                    
                    log(`Error details: ${message}`, 'error');
                    updateStatus('WebSocket connection failed', 'error');
                    resolve(false);
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`üì® Received: ${data.type}`, 'info');
                        
                        if (data.type === 'pong') {
                            log('‚úÖ Ping-pong test successful', 'success');
                        }
                    } catch (e) {
                        log(`üì® Received message (${event.data.length} chars)`, 'info');
                    }
                };
                
                ws.onclose = function(event) {
                    if (!connected) {
                        addResult('websocket', false, 'WebSocket', 'error');
                        updateChecklist(2, false);
                        log(`‚ùå WebSocket closed: code ${event.code}`, 'error');
                        updateStatus('WebSocket connection failed', 'error');
                        resolve(false);
                    } else {
                        log('WebSocket connection closed normally', 'info');
                    }
                };
                
                // Timeout after 5 seconds
                timeout = setTimeout(() => {
                    ws.close();
                    if (!connected) {
                        addResult('websocket', false, 'WebSocket', 'error');
                        updateChecklist(2, false);
                        log('‚ùå WebSocket connection timeout (5 seconds)', 'error');
                        updateStatus('WebSocket connection timeout', 'error');
                        resolve(false);
                    }
                }, 5000);
            });
        }
        
        async function testFrontend() {
            log('Testing frontend connectivity...', 'info');
            // Simple test - if we're here, frontend is running
            updateChecklist(3, true);
            return true;
        }
        
        async function runAllTests() {
            logs.innerHTML = '';
            results.innerHTML = '';
            testResults = {};
            
            log('üöÄ Starting all diagnostic tests...', 'info');
            updateStatus('Running all tests...', 'warning');
            
            // Reset checklist
            for (let i = 1; i <= 5; i++) {
                updateChecklist(i, false);
            }
            
            // Test frontend first (we're already running)
            await testFrontend();
            
            // Test backend
            const backendData = await testBackend();
            
            if (backendData) {
                // Add backend info
                addResult('connections', backendData.active_connections || 0, 'Active Connections');
                addResult('models', backendData.ml_models_loaded || false, 'ML Models Loaded');
                
                // Test WebSocket
                await testWebSocket();
                
                // Test CORS by making a cross-origin request
                log('Testing CORS...', 'info');
                try {
                    const testResponse = await fetch('http://localhost:8000/api/v1/health');
                    if (testResponse.headers.get('access-control-allow-origin')) {
                        log('‚úÖ CORS headers present', 'success');
                        updateChecklist(4, true);
                    } else {
                        log('‚ö†Ô∏è CORS headers not found', 'warning');
                        updateChecklist(4, false);
                    }
                } catch (e) {
                    log('‚ùå CORS test failed', 'error');
                    updateChecklist(4, false);
                }
                
                // Final summary
                const passed = Object.values(testResults).filter(r => r.value === true || r.value > 0).length;
                const total = Object.keys(testResults).length;
                
                addResult('summary', `${passed}/${total}`, 'Tests Passed', passed === total ? 'success' : 'warning');
                
                if (passed === total) {
                    log('üéâ All tests passed! System is ready.', 'success');
                    updateStatus('All tests passed! System is ready.', 'success');
                    updateChecklist(5, true);
                } else {
                    log(`‚ö†Ô∏è ${total - passed} test(s) failed. Check logs for details.`, 'warning');
                    updateStatus('Some tests failed', 'error');
                }
            } else {
                log('‚ùå Backend test failed. Skipping remaining tests.', 'error');
                updateStatus('Backend not running. Please start backend first.', 'error');
            }
            
            log('All tests completed', 'info');
        }
        
        // Auto-run tests on page load after a delay
        setTimeout(() => {
            log('Page loaded. Ready for testing.', 'info');
            // Uncomment the line below to auto-run tests on page load
            // runAllTests();
        }, 1000);
    </script>
</body>
</html>